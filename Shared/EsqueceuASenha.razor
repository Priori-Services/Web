@inject IToastService Toast
@using PRIORI_SERVICES_WEB.Handler
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject ISMTPService SMTP
@inject IAsyncService AsyncService
@using System.Net.Mail

<div class="card-body text-dark px-5">
    @if (!EmailEnviado)
    {
        <h1>Espere enquanto estamos enviando um email para confirmação...</h1>
    }
    else
    {
        @if (!CodigoCorreto)
        {
            <p class="card-text fs-2 py-2">
                Digite aqui o código de confirmação enviado ao email @UsuarioFull!.email
            </p>
            <div class="form-outline">
                <input type="text" @bind="CodigoInput" @bind:event="oninput" id="typeEmail" class="form-control my-3" />
            </div>
            <button @onclick="() => CodigoCorreto = (CodigoInput == CodigoGen)" class="btn btn-primary w-100">Verificar
                Código</button>
        }
        else
        {
            <p class="fs-3">Insira sua nova senha</p>
            <div class="form-outline">
                <input type="password" @bind="SenhaNovaInput" @bind:event="oninput" id="typeEmail" class="form-control my-3" />
            </div>

            <p class="">Confirmação de senha</p>
            <div class="form-outline">
                <input type="password" @bind="SenhaNovaConfirm" @bind:event="oninput" id="typeEmail" class="form-control my-3" />
            </div>

            <button @onclick="@(() => AsyncService.RunTaskAsSync(AlterarSenha))" class="btn btn-primary w-100">Alterar
                Senha</button>
        }
    }
</div>

@code {
    private bool EmailEnviado { get; set; } = false;
    private bool CodigoCorreto { get; set; } = false;
    private string CodigoGen { get; set; } = String.Empty;
    [Parameter] public UserCredentials? UsuarioFull {get;set;}

    [CascadingParameter] BlazoredModalInstance BlazoredModal { get; set; } = default!;
    private string CodigoInput { get; set; } = String.Empty;
    private string SenhaNovaInput { get; set; } = String.Empty;
    private string SenhaNovaConfirm { get; set; } = String.Empty;
    protected override void OnInitialized()
    {
        CodigoGen = SMTP.GenerateAuthenticationID(6);

        var mailMessage = new MailMessage
            {
                From = new MailAddress(ConfigHandler.PRIORI_EMAIL_ADDRESS),
                Subject = "Redefinição de senha Priori",
                Body = $"<h1>Redefinição de senha Priori</h1><h2>Seu código de recuperação de senha é: {CodigoGen}</h2>",
                IsBodyHtml = true
            };

        try
        {
            SMTP.SendMailTo(mailMessage, UsuarioFull!.email);
        }
        catch (SmtpException)
        {
            Toast.ShowError("Falha ao enviar email");
            return;
        }

        EmailEnviado = true;
        Toast.ShowSuccess("Email enviado com sucesso!");
    }

    private async Task AlterarSenha()
    {
        if (SenhaNovaInput != SenhaNovaConfirm)
        {
            Toast.ShowError("As senhas digitadas não são iguais");
            return;
        }
        @*TODO: Verificações válidas de senha daqui!*@
        const string FAILURE_STATE = "Falha ao mudar a senha";


        HttpResponseMessage response;
        try
        {
            response = await APIHandler.PutRequestAsync(new Dictionary<string, object> {
{"email", UsuarioFull!.email},
{"senha", SenhaNovaInput}}, $"/Auth/Cliente/senha/reset");
        }
        catch (Exception)
        {
            Toast.ShowError(FAILURE_STATE);
            return;
        }

        if (!response.IsSuccessStatusCode)
        {
            Toast.ShowError(FAILURE_STATE);
            Console.WriteLine(response.StatusCode);
            return;
        }

        Toast.ShowSuccess("Senha alterada com sucesso!");
        await BlazoredModal.CloseAsync();
    }
}
