@page "/blog"
@using PRIORI_SERVICES_WEB.Handler
@using System.Net.Http.Headers
@inject IAsyncService AsyncService
@inject ILocalStorageService LocalStorage
@inject IToastService Toast
@inject NavigationManager NavigationManager

<NavMenu nav_classes="sticky-top" />

<style>
    body {
    @BackgroundGradients.BackgroundPrincipal
    }
    .fonte-blog {
        font-family: "Poppins", sans-serif;
        line-height: 2;
        font-weight: 150;
        margin-left: 200px;
        margin-right: 200px;
        letter-spacing: 2px;
    }
</style>

    <header class="pb-5 pt-5 border-bottom mb-4 text-light">
            <div class="container">
                <div class="text-center text-light">
                    <h1 class="fw-bolder bd-dark text-light">Bem vindo ao Blog <i>Priori</i>!</h1>
                    <p class="lead mb-0 bd-dark text-light">Mantenha-se informado com os nossos artigos econômicos e saiba tudo sobre o mercado acompanhando nossas redes publicações.</p>
                </div>
            </div>
    </header>
        <!-- Conteúdo-->
    <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="row">
                        <div class="col-lg-14">
                            <!--Posts-->
                            <div class="card mb-4">
                                <img class="card-img-top mt-4" src="assets/Logo_Priori_Services.png" 
                                alt="..." style="width: 13rem; margin-left: 350px;"/>
                                <div class="card-body">

                                    @foreach (var item in PageBlogPosts)
                                    {
                                        <div class="card px-3 py-3 m-3 border rounded-3 bg-white">
                                            <p @onclick="@(() => InitPostViewer(item, GetCategoriaBlogFromID(item.id_categoria)))"
                                                class="text-dark text-decoration-none">

                                    <div class="small text-muted">@item.data_criacao</div>
                                    <h2 class="card-title h4">@item.titulo</h2>
                                    <p class="card-text">@item.descricao</p>

                                            <span
                                                class="badge bg-primary rounded-pill">@GetCategoriaBlogFromID(@item.id_categoria).nome_categoria</span>
                                            </p>
                                        </div>
                                    }

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Widgets laterais-->
                <div class="col-lg-4">
                    <!-- Widget Cartegorias-->
                    <div class="card mb-4">
                        <div class="card-header">Cartegorias</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6">
                                    <ul class="list-unstyled">
                                        <li class="my-1"><a href="#!">Taxas de Rentabilidade</a></li>
                                        <li class="my-1"><a href="#!">Programa de Pontos</a></li>
                                        <li class="my-1"><a href="#!">A Priori</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Side widget-->
                    <div class="card mb-4">
                        <div class="card-header"><i>Priori Services</i></div>
                        <div class="card-body">Sabia que a <i>Priori</i> sempre traz inovação pensando nos nossos clientes? Aproveite!</div>
                    </div>
                    <!-- Widget funções-->
                    <div class="card mb-4">
                    @if (isUserConsultor)
                        {
                            <div class="card-header mb-3">Funções de Consultor</div>
                            <nav class="container">
                                <ul class="pagination">
                                    <li class="page-item me-3">
                                        <button class="page-link bg-warning text-white"
                                        @onclick="@(() => AsyncService.RunTaskAsSync(InitAdicionarAsync))">Adicionar Post</button>
                                    </li>
                                    <li class="page-item me-3">
                                        <button @onclick="@(() => AsyncService.RunTaskAsSync(InitRemoverAsync))"
                                            class="page-link bg-danger text-white">Remover Post</button>
                                    </li>
                                    <li class="page-item">
                                        <button @onclick="@(() => AsyncService.RunTaskAsSync(InitAlterarAsync))"
                                            class="page-link bg-primary text-white">Editar Post</button>
                                    </li>
                                </ul>
                            </nav>
                    }
                    </div>
                </div>
            </div>
        </div>

<Footer />

@code {
    public PostBlog[] PageBlogPosts = new PostBlog[0];
    public CategoriaBlog[] PageBlogCategoria = new CategoriaBlog[0];
    private string? user_id { get; set; }
    private string? app_token { get; set; }
    public bool isUserConsultor { get; set; } = false;
    [CascadingParameter] public IModalService Modal_Viewer { get; set; } = default!;
    [CascadingParameter] public IModalService Modal_Adicionar { get; set; } = default!;
    public const string NO_AUTH_FAILURE_STATE = "Você não tem permissão para adicionar posts";

    public async Task<int?> CheckUserIsConsultor(string user_id, string app_token)
    {
        int id_consultor;

        APIHandler.static_client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", app_token);
        try
        {
            id_consultor = await APIHandler.FetchAbstractJsonObjectAsync<int>($"/Auth/Cliente/idconsultor/{user_id}");
        }
        catch (Exception)
        {
            return null;
        }
        finally
        {
            APIHandler.static_client.DefaultRequestHeaders.Authorization = null;
        }

        return id_consultor;
    }

    public async Task InitAlterarAsync()
    {
        if (user_id == "" || user_id == String.Empty || user_id == null ||
        app_token == "" || app_token == String.Empty || app_token == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        int? id_consultor = await CheckUserIsConsultor(user_id, app_token);

        if (id_consultor == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        var param = new ModalParameters();
        param.Add(nameof(PostAlterar.posts), PageBlogPosts);
        param.Add(nameof(PostAlterar.autor_post), id_consultor.ToString()!);
        param.Add(nameof(PostAlterar.categorias), PageBlogCategoria);
        param.Add(nameof(PostAlterar.app_token), app_token);
        var modal_remover_post = Modal_Adicionar.Show<PostAlterar>("Remover Post", param);
        var result = await modal_remover_post.Result;

        NavigationManager.NavigateTo("/blog");
    }

    public async Task InitRemoverAsync()
    {
        if (user_id == "" || user_id == String.Empty || user_id == null ||
        app_token == "" || app_token == String.Empty || app_token == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        int? id_consultor = await CheckUserIsConsultor(user_id, app_token);

        if (id_consultor == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        var param = new ModalParameters();
        param.Add(nameof(PostDelete.posts), PageBlogPosts);
        param.Add(nameof(PostDelete.app_token), app_token);
        var modal_remover_post = Modal_Adicionar.Show<PostDelete>("Remover Post", param);
        var result = await modal_remover_post.Result;

        NavigationManager.NavigateTo("/blog");
    }

    public async Task InitAdicionarAsync()
    {
        if (user_id == "" || user_id == String.Empty || user_id == null ||
        app_token == "" || app_token == String.Empty || app_token == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        int? id_consultor = await CheckUserIsConsultor(user_id, app_token);

        if (id_consultor == null)
        {
            Toast.ShowError(NO_AUTH_FAILURE_STATE);
            return;
        }

        var param = new ModalParameters();
        param.Add(nameof(PostAdd.autor_post), id_consultor);
        param.Add(nameof(PostAdd.app_token), app_token);
        param.Add(nameof(PostAdd.AllCategorias), PageBlogCategoria);
        var modal_adicionar_post = Modal_Adicionar.Show<PostAdd>("Adicionar Post", param);
        var result = await modal_adicionar_post.Result;

        NavigationManager.NavigateTo("/blog");
    }

    public void InitPostViewer(PostBlog post_obj, CategoriaBlog categoria_obj)
    {
        SimulacaoID.PostMain = post_obj;
        SimulacaoID.CategoriaMain = categoria_obj;
        NavigationManager.NavigateTo("/blog-viewer");
    }

    public CategoriaBlog GetCategoriaBlogFromID(int id)
    {
        foreach (var categoria in PageBlogCategoria)
        {
            if (categoria.id_categoria == id)
            {
                return categoria;
            }
        }
        return new CategoriaBlog
            {
                nome_categoria = "Falha ao encontrar categoria"
            };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        user_id = await LocalStorage.GetItemAsStringAsync(LocalStorageKeys.user_id.ToString());
        app_token = await LocalStorage.GetItemAsStringAsync(LocalStorageKeys.app_token.ToString());

        if (user_id == "" || user_id == String.Empty || user_id == null ||
        app_token == "" || app_token == String.Empty || app_token == null)
        {
            return;
        }

        int? id_consultor = await CheckUserIsConsultor(user_id, app_token);

        isUserConsultor = !(id_consultor == null);

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        PageBlogPosts = await APIHandler.FetchOrFallbackAsync<PostBlog[]>(
        "/Blog/Posts",
        new PostBlog[] { new PostBlog { titulo = "Falha ao encontrar posts" } }
        );

        PageBlogCategoria = await APIHandler.FetchOrFallbackAsync<CategoriaBlog[]>(
        "/Blog/Categorias",
        new CategoriaBlog[]{
new CategoriaBlog {
id_categoria = 999,
nome_categoria = "Falha ao encontrar categoria"
}
        });
    }
}
